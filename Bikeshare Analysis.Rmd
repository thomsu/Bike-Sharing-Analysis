---
title: "Bike Sharing Analysis"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Cmd+Shift+Enter*. 

```{r}
library(knitr)

project_folder <- "./Chicago_Bike_Share"

if (!dir.exists(project_folder)) {
  dir.create(project_folder)
}

knitr::opts_knit$set(root.dir = project_folder)
```

```{r}
packages <- c("dplyr", "DBI", "skimr", "stringr", "tidyr", "tibble", "lubridate", "geosphere", "ggplot2", "ggmap", "ggthemes", "gridExtra", "gganimate", "modeest", "chorddiag", "htmlwidgets")

install.packages(setdiff(packages, rownames(installed.packages())))

for (pkg in packages) {
  library(pkg, character.only = TRUE, warn.conflicts = FALSE, quietly = TRUE)
}
```

```{r}
url_start <- 'https://divvy-tripdata.s3.amazonaws.com/'
dates <- format(seq(as.Date("2020/4/1"), as.Date("2021/3/1"), "months"), "%Y%m")
url_end <- '-divvy-tripdata.zip'
full_url <- vector()

for (date in dates) {
  full_url <- append(full_url, paste(url_start, date, url_end, sep=''))
}

filenames <- vector()
start_index <- nchar(url_start) + 1L

for (url_link in full_url) {
  end_index <- nchar(url_link) - 4L
  filenames <- append(filenames, paste(substr(url_link, start_index, end_index),'.csv',sep=''))
}
```

```{r}
connect <- dbConnect(RSQLite::SQLite(), "local_sqldb.sqlite", extended_type=TRUE)

field_names <-  c("ride_id" = "TEXT",
    "rideable_type" = "TEXT",
    "started_at" = "TIMESTAMP",
    "ended_at" = "TIMESTAMP",
    "start_station_name" = "TEXT",
    "start_station_id"  = "INTEGER",
    "end_station_name" = "TEXT",
    "end_station_id" = "INTEGER",
    "start_lat" = "REAL",
    "start_lng" = "REAL",
    "end_lat" = "REAL",
    "end_lng" = "REAL",
    "member_casual" = "TEXT")

if (!dbExistsTable(connect, "bikeshare")) {
  dbCreateTable(connect, "bikeshare", field_names)
}

dbDisconnect(connect)
```

```{r}
connect <- dbConnect(RSQLite::SQLite(), "local_sqldb.sqlite", extended_type=TRUE)

query <- dbSendQuery(connect, 'select * from bikeshare')

if (nrow(dbFetch(query, n = 10)) == 0) {
  for (i in seq(full_url)) {
    temp <- tempfile()
    url_link <- full_url[i]
    csv_file <- filenames[i]
    download.file(url_link, temp)
    data <- read.csv(unz(temp, csv_file))
    dbAppendTable(connect, "bikeshare", data)
    unlink(temp)
  }
}

dbClearResult(query)
dbDisconnect(connect)
```

```{r}
connect <- dbConnect(RSQLite::SQLite(), "local_sqldb.sqlite", extended_type=TRUE)

bikeshare_df <- dbReadTable(connect, "bikeshare")
head(bikeshare_df)

dbDisconnect(connect)
```

```{r}
skim(bikeshare_df)
```

```{r}
print(paste("There are", nrow(bikeshare_df[!complete.cases(bikeshare_df),]), "rows with missing values, excluding empty fields.", sep = " "))
```

```{r}
bikeshare_df %>%
  filter(is.na(start_station_id)) %>% 
  head()
```

```{r}
bikeshare_df %>%
  filter(start_station_name == '') %>% 
  arrange(started_at) %>% 
  head()
```

```{r}
bikeshare_df %>%
  filter(start_station_name == '') %>% 
  arrange(desc(started_at)) %>% 
  head()
```

```{r}
bikeshare_df %>%
  filter(start_station_name == '' & !is.na(start_station_id)) %>% 
  arrange(started_at) %>% 
  head()
```

```{r}
bikeshare_df %>%
  filter(start_station_name == '' & !is.na(start_station_id)) %>% 
  arrange(desc(started_at)) %>% 
  head()
```

```{r}
bikeshare_df %>%
  filter(start_station_name != '' & start_station_id == 0) %>% 
  summarize(name_count = n_distinct(start_station_name)) 
```

```{r}
bikeshare_df %>%
  filter(start_station_name == '' & !is.na(start_station_id) & start_station_id != 0) %>% 
  head()
```

```{r}
bikeshare_df %>%
  filter(end_station_name == '' & !is.na(end_station_id) & end_station_id != 0) %>% 
  head()
```

```{r}
bikeshare_df %>%
  filter(start_station_name == '' & rideable_type != 'electric_bike') %>% 
  head()
```

```{r}
bikeshare_df %>% 
  filter(end_station_name == '' & rideable_type != 'electric_bike') %>% 
  head()
```

```{r}
search_result <- bikeshare_df %>% 
  filter(!is.na(start_station_id) & start_station_id != 0) %>%
  group_by(start_station_id) %>%
  summarize(count_station_name = n_distinct(start_station_name)) %>% 
  filter(count_station_name > 1)

search_result
```

```{r}
bikeshare_df %>% 
  select(start_station_id, start_station_name) %>% 
  filter(start_station_id %in% search_result$start_station_id) %>%
  group_by(start_station_id, start_station_name) %>% 
  summarize()
```

```{r}
search_result <- bikeshare_df %>% 
  filter(!is.na(start_station_name) & start_station_id != 0) %>%
  group_by(start_station_name) %>%
  summarize(count_station_id = n_distinct(start_station_id)) %>% 
  filter(count_station_id > 1)

search_result
```

```{r}
bikeshare_df %>% 
  select(start_station_id, start_station_name) %>% 
  filter(start_station_name %in% search_result$start_station_name) %>%
  group_by(start_station_name, start_station_id) %>% 
  summarize(.groups = "drop")
```

```{r}
bikeshare_df %>% 
  filter(start_station_name == end_station_name & start_station_id != 0) %>% 
  head()
```

```{r}
bikeshare_df <- bikeshare_df %>% 
  mutate(month_of_year = as.factor(paste(format(as.Date(started_at), "%Y"), ".", format(as.Date(started_at), "%m"), sep = "")), 
         day_of_week = weekdays(as.Date(started_at)), 
         hour_of_day = as.factor(paste(str_pad(hour(as_datetime(started_at)), 2, "left", pad = 0), "00", sep = ":")), 
         quarter_of_year = quarter(as.Date(started_at), with_year = TRUE))

head(bikeshare_df)
```

```{r}
mile_conversion = 0.0006213711922373339

bikeshare_df <- mutate(bikeshare_df, trip_duration = as.period(interval(ymd_hms(started_at, tz = "America/Chicago"), ymd_hms(ended_at, tz = "America/Chicago"))))
bikeshare_df <- mutate(bikeshare_df, trip_distance = distHaversine(cbind(start_lng, start_lat),
                cbind(end_lng, end_lat)) * mile_conversion)

head(bikeshare_df)
```

```{r}
ggplot(bikeshare_df  %>% filter(start_station_name == end_station_name & start_station_id != 0), aes(x = as.numeric(as.duration(trip_duration), "minutes"))) + geom_histogram(binwidth = 5) +
  xlim(-180, 1600) +
  scale_y_continuous(trans='log2') +
  xlab("Duration (minutes)") +
  ylab("Logarithmic Number of Trips") +
  ggtitle("Logarithmic Count of Trips Starting and Ending at the Same Location")
```

```{r}
bikeshare_df %>% 
  filter(trip_duration < period(c(0, 0), c('second', 'minute'))) %>% 
  arrange(trip_duration)
```

```{r}
bikeshare_df <- bikeshare_df %>% 
  filter(trip_duration > period(c(0, 0), c('second', 'minute')))

bikeshare_df %>% arrange(desc(trip_duration))
```

```{r}
bikeshare_df <- bikeshare_df %>% 
  filter(start_station_name != end_station_name | (start_station_name == end_station_name & trip_duration > period(c(0, 5), c('second', 'minute'))))
```

```{r}
ggplot(bikeshare_df, aes(x = rideable_type, fill = member_casual)) +
  geom_histogram(stat = "count", alpha = .8) +
  stat_count(aes(y = ..count.., label = ..count..), geom = "text", vjust = 1.2, size =3, alpha = .8) +
  xlab(" ") +
  ylab("Total number of trips") +
  guides(fill=guide_legend(title="Rider Type")) + 
  theme(panel.grid.minor.x=element_blank(), panel.grid.major.x=element_blank()) +
  ggtitle("Rider Usage by Type of Bike")
```

```{r}
ggplot(bikeshare_df, aes(x = rideable_type, y = as.numeric(as.duration(trip_duration), "minutes"), fill = member_casual)) +
  geom_bar(position = "dodge", stat = "summary", fun = "mean", alpha = .8) +
  stat_summary(aes(label = round(..y.., 2)), fun = "mean", geom = "text", vjust = -0.5, position = position_dodge(0.9), size = 3, alpha = .8) +
  xlab(" ") +
  ylab("Average Duration of Trip (minutes)") +
  guides(fill = guide_legend(title = "Rider Type")) + 
  theme(panel.grid.minor.x = element_blank(), panel.grid.major.x = element_blank()) +
  ggtitle("Average Trip Duration by Type of Bike")
```

```{r}
daily_trip_df <- bikeshare_df %>%
  select(started_at, day_of_week) %>%
  group_by(as.Date(started_at)) %>%
  summarize(daily_trip_count = length(started_at), day_of_week = first(day_of_week))

daily_trip_df$day_of_week <- factor(daily_trip_df$day_of_week, levels = weekdays(x=as.Date(seq(7), origin='1950-01-01')))

ggplot(daily_trip_df, aes(x = day_of_week, y = daily_trip_count)) + 
  geom_violin(color = 'navy') +
  geom_dotplot(binwidth = 750, binaxis = 'y', stackdir = 'center', dotsize = .5, color = "grey", alpha = .7) +
  xlab("") +
  ylab("Daily Total Number of Trips") +
  theme(panel.grid.minor.x = element_blank(), panel.grid.major.x = element_blank()) +
  ggtitle("Daily Trip Count by Day of Week")
```

```{r}
daily_trip_df <- bikeshare_df %>%
  filter(member_casual == 'member') %>%
  select(started_at, day_of_week) %>%
  group_by(as.Date(started_at)) %>%
  summarize(daily_trip_count = length(started_at), day_of_week = first(day_of_week))

daily_trip_df$day_of_week <- factor(daily_trip_df$day_of_week, levels = weekdays(x=as.Date(seq(7), origin='1950-01-01')))

ggplot(daily_trip_df, aes(x = day_of_week, y = daily_trip_count)) + 
  geom_violin(color = 'navy', fill = 'turquoise', alpha = .8) +
  geom_dotplot(binwidth = 750, binaxis = 'y', stackdir = 'center', dotsize = .2, color = "grey", alpha = .7) +
  xlab("") +
  ylab("Daily Total Number of Trips") +
  theme(panel.grid.minor.x = element_blank(), panel.grid.major.x = element_blank()) +
  ggtitle("Daily Member Trip Count by Day of Week")
```

```{r}
daily_trip_df <- bikeshare_df %>%
  filter(member_casual == 'casual') %>%
  select(started_at, day_of_week) %>%
  group_by(as.Date(started_at)) %>%
  summarize(daily_trip_count = length(started_at), day_of_week = first(day_of_week))

daily_trip_df$day_of_week <- factor(daily_trip_df$day_of_week, levels = weekdays(x=as.Date(seq(7), origin='1950-01-01')))

ggplot(daily_trip_df, aes(x = day_of_week, y = daily_trip_count)) + 
  geom_violin(color = 'navy', fill = 'coral', alpha = .8) +
  geom_dotplot(binwidth = 750, binaxis = 'y', stackdir = 'center', dotsize = .3, color = "grey", alpha = .7) +
  xlab("") +
  ylab("Daily Total Number of Trips") +
  theme(panel.grid.minor.x = element_blank(), panel.grid.major.x = element_blank()) +
  ggtitle("Daily Casual Trip Count by Day of Week")
```

```{r}
hourly_trip_df <- bikeshare_df %>%
  group_by(date = as.Date(started_at), hour_of_day) %>%
  summarize(hourly_trip_count = length(hour_of_day), .groups = "drop")

ggplot(hourly_trip_df, aes(y = hour_of_day, x = hourly_trip_count)) + 
  geom_boxplot(color = "navy", alpha = .7) +
  scale_y_discrete(limits=rev) +
  xlab("Total Number of Trips") +
  ylab("Hour of Day") +
  theme(panel.grid.minor.y=element_blank(), panel.grid.major.y=element_blank()) +
ggtitle("Hourly Trip Count")
```

```{r}
hourly_trip_df <- bikeshare_df %>%
  filter(member_casual == "member") %>% 
  group_by(date = as.Date(started_at), hour_of_day) %>%
  summarize(hourly_trip_count = length(hour_of_day), .groups = "drop")

ggplot(hourly_trip_df, aes(y = hour_of_day, x = hourly_trip_count)) + 
  geom_boxplot(color = "navy", alpha = .9, fill = "turquoise") +
  scale_y_discrete(limits=rev) +
  xlab("Total Number of Trips") +
  ylab("Hour of Day") +
  theme(panel.grid.minor.y=element_blank(), panel.grid.major.y=element_blank()) +
  ggtitle("Hourly Member Trip Count")
```

```{r}
hourly_trip_df <- bikeshare_df %>%
  filter(member_casual == "casual") %>% 
  group_by(date = as.Date(started_at), hour_of_day) %>%
  summarize(hourly_trip_count = length(hour_of_day), .groups = "drop")

ggplot(hourly_trip_df, aes(y = hour_of_day, x = hourly_trip_count)) + 
  geom_boxplot(color = "navy", alpha = .9, fill = "coral") +
  scale_y_discrete(limits=rev) +
  xlab("Total Number of Trips") +
  ylab("Hour of Day") +
  theme(panel.grid.minor.y=element_blank(), panel.grid.major.y=element_blank()) +
  ggtitle("Hourly Casual Trip Count")
```

```{r}
modified_bikeshare_df <- bikeshare_df %>% 
  filter(trip_duration <= period(c(0, 0, 16), c('second', 'minute', 'hour')))
```

```{r}
ggplot(modified_bikeshare_df, aes(x = as.numeric(as.duration(trip_duration), "minutes"), fill = member_casual)) +
  geom_histogram(binwidth = 10, alpha = .8) +
  scale_y_continuous(trans='log2') +
  facet_wrap(~ member_casual) +
  xlab("Duration of Trip (minutes)") +
  ylab("Logarithmic Number of Trips") +
  guides(fill=guide_legend(title = "Rider Type")) + 
  theme(panel.grid.minor.x=element_blank(), panel.grid.major.x=element_blank()) +
  ggtitle("Logarithmic Count of Trips by Trip Duration")
```

```{r}
monthly_trip_df <- bikeshare_df %>%
  group_by(month_of_year, member_casual) %>%
  summarize(grouped_average_duration = mean(as.numeric(as.duration(trip_duration), "minutes"), na.rm = TRUE), grouped_std_dev = sd(as.numeric(as.duration(trip_duration), "minutes"), na.rm = TRUE), .groups = "drop")

ggplot(monthly_trip_df, aes(x = month_of_year, y = grouped_average_duration, group = member_casual)) + 
  geom_line(aes(x = month_of_year, y = grouped_average_duration, color = member_casual, linetype = member_casual)) +
  geom_ribbon(aes(ymin = grouped_average_duration - grouped_std_dev, ymax = grouped_average_duration + grouped_std_dev, fill = member_casual), alpha = 0.2) +
  xlab(" ") +
  ylab("Average Trip Duration (minutes)") +
  scale_x_discrete(labels = c(paste(month.abb[c(4:12)], 2020), paste(month.abb[c(1:3)], 2021))) +
  guides(color = guide_legend(title = "Rider Type"), fill = guide_legend(title = "Rider Type"), linetype = guide_legend(title = "Rider Type")) +
  ggtitle("Average Trip Duration by Month of Year")
```

```{r}
start_station_df <- bikeshare_df %>% 
  filter(start_station_name != "") %>% 
  with_groups(start_station_name, mutate, start_lat = mlv(start_lat, method = "mfv")[1], start_lng = mlv(start_lng, method = "mfv")[1]) %>% 
  group_by(member_casual, start_station_name) %>%
  summarize(trip_count = length(start_station_name), start_lat = first(start_lat), start_lng = first(start_lng), .groups = "drop_last")
  
start_station_df
```

```{r}
basemap <- ggmap(get_stamenmap(c(left = min(start_station_df$start_lng) - .05,
                  bottom = min(start_station_df$start_lat) - .01,
                  right = max(start_station_df$start_lng) + .05,
                  top = max(start_station_df$start_lat)) + .01,
                  maptype = "toner-lite", zoom = 11))

basemap + 
  geom_point(aes(x = start_lng, y = start_lat), data = start_station_df, color = "navy", size = 0.5) +
  theme_nothing()
```

```{r}
top_start_df <- start_station_df %>% 
  slice_max(trip_count, n = 50)

basemap <- ggmap(get_stamenmap(c(left = min(top_start_df$start_lng) - .05,
                  bottom = min(top_start_df$start_lat) - .01,
                  right = max(top_start_df$start_lng) + .05,
                  top = max(top_start_df$start_lat)) + .01,
                  maptype = "toner-lite", zoom = 13))

basemap + 
  geom_point(aes(x = start_lng, y = start_lat, size = trip_count, color = member_casual), data = top_start_df, alpha = .7) +
  facet_wrap(~ member_casual) +
  xlab(" ") +
  ylab(" ") +
  guides(size = "none", color = guide_legend(title="Rider Type")) +
  theme(axis.text = element_blank(), axis.ticks = element_blank(), axis.title = element_blank())
```

```{r}
member_start_df <- start_station_df %>% filter(member_casual == "member") %>% 
  slice_max(trip_count, n = 50)

label_meta <- member_start_df
number_of_bars <- nrow(label_meta)
angle <-  90 - 360 * (c(1:number_of_bars) - 0.5) / number_of_bars
label_meta$hjust <- ifelse(angle < -90, 1, 0)
label_meta$angle <- ifelse(angle < -90, angle + 180, angle)

ggplot(member_start_df, aes(x = as.factor(reorder(start_station_name, trip_count)), y = trip_count)) +
  geom_bar(stat = "identity", fill = "turquoise", alpha = .8) +
  ylim(-10000, 20000) +
  theme(axis.text = element_blank(), axis.ticks = element_blank(), axis.title = element_blank(), plot.margin = unit(rep(-1, 4), "cm")) +
  coord_polar() +
  geom_text(data = label_meta, aes(x = start_station_name, y = trip_count, label = paste(start_station_name, trip_count, sep = ": "), hjust = hjust), color = "black", fontface = "bold", alpha = 0.6, size = 2.5, angle = -label_meta$angle, inherit.aes = FALSE) 
```

```{r}
casual_start_df <- start_station_df %>% filter(member_casual == "casual") %>% 
  slice_max(trip_count, n = 50)

label_meta <- casual_start_df
number_of_bars <- nrow(label_meta)
angle <-  90 - 360 * (c(1:number_of_bars) - 0.5) / number_of_bars
label_meta$hjust <- ifelse(angle < -90, 1, 0)
label_meta$angle <- ifelse(angle < -90, angle + 180, angle)

ggplot(casual_start_df, aes(x = as.factor(reorder(start_station_name, trip_count)), y = trip_count)) +
  geom_bar(stat = "identity", fill = "coral", alpha = .8) +
  ylim(-15000, 27500) +
  xlab(" ") +
  ylab(" ") +
  theme(axis.text = element_blank(), axis.ticks = element_blank(), axis.title = element_blank(), plot.margin = unit(rep(-1, 4), "cm")) +
  coord_polar() +
  geom_text(data = label_meta, aes(x = start_station_name, y = trip_count, label = paste(start_station_name, trip_count, sep = ": "), hjust = hjust), color = "black", fontface = "bold", alpha = 0.6, size = 2.5, angle = -label_meta$angle, inherit.aes = FALSE)
```

```{r}
end_station_df <- bikeshare_df %>% 
  filter(end_station_name != "") %>% 
  with_groups(end_station_name, mutate, end_lat = mlv(end_lat, method = "mfv")[1], end_lng = mlv(end_lng, method = "mfv")[1]) %>% 
  group_by(member_casual, end_station_name) %>%
  summarize(trip_count = length(end_station_name), end_lat = first(end_lat), end_lng = first(end_lng), .groups = "drop_last")

end_station_df
```

```{r}
top_end_df <- end_station_df %>% 
  slice_max(trip_count, n = 50)

basemap <- ggmap(get_stamenmap(c(left = min(top_end_df$end_lng) - .05,
                  bottom = min(top_end_df$end_lat) - .01,
                  right = max(top_end_df$end_lng) + .05,
                  top = max(top_end_df$end_lat)) + .01,
                  maptype = "toner-lite", zoom = 13))

basemap + 
  geom_point(aes(x = end_lng, y = end_lat, size = trip_count, color = member_casual), data = top_end_df, alpha = .7) + 
  facet_wrap(~ member_casual) +
  xlab(" ") +
  ylab(" ") +
  guides(size = "none", color = guide_legend(title="Rider Type")) +
  theme(axis.text = element_blank(), axis.ticks = element_blank(), axis.title = element_blank())
```

```{r}
member_end_df <- end_station_df %>% filter(member_casual == "member") %>% 
  slice_max(trip_count, n = 50)

casual_end_df <- end_station_df %>% filter(member_casual == "casual") %>% 
  slice_max(trip_count, n = 50)

empty_bar <- 5
empty_block <- bind_rows(head(member_end_df, n = empty_bar), head(casual_end_df, n = empty_bar))
empty_block[-1] <- na_if(empty_block[-1], empty_block[-1])
end_station_df <- bind_rows(member_end_df, casual_end_df, empty_block)
end_station_df <- end_station_df %>% arrange(member_casual)
end_station_df$id <- seq(1, nrow(end_station_df))

label_meta <- end_station_df
number_of_bars <- nrow(label_meta)
angle <-  90 - 360 * (c(1:number_of_bars) - 0.5) / number_of_bars
label_meta$hjust <- ifelse(angle < -90, 1, 0)
label_meta$angle <- ifelse(angle < -90, angle + 180, angle)

ggplot(end_station_df, aes(x = as.factor(id), y = trip_count, fill = member_casual)) +
  geom_bar(stat = "identity", alpha = .8) +
  ylim(-5000, 40000) +
  guides(fill=guide_legend(title="Rider Type")) +
  theme(axis.text = element_blank(), axis.ticks = element_blank(), axis.title = element_blank(), plot.margin = unit(rep(-1, 4), "cm")) +
  coord_polar() +
  geom_text(data = label_meta, aes(x = id, y = trip_count, label = paste(end_station_name, trip_count, sep = ": "), hjust = hjust), color = "black", fontface = "bold", alpha = 0.6, size = 2.5, angle = label_meta$angle, inherit.aes = FALSE) 
```

```{r}
route_df <- bikeshare_df %>%
  filter(start_station_name != "" & end_station_name != "" & start_station_name != end_station_name) %>% 
  with_groups(start_station_name, mutate, start_lat = mlv(start_lat, method = "mfv")[1], start_lng = mlv(start_lng, method = "mfv")[1]) %>% 
  with_groups(end_station_name, mutate, end_lat = mlv(end_lat, method = "mfv")[1], end_lng = mlv(end_lng, method = "mfv")[1]) %>% 
  group_by(started_hour = paste(hour_of_day, "00", sep = ":"), member_casual, start_lat, start_lng, end_lat, end_lng) %>% 
  summarize(route_count = length(end_lng), .groups = "drop") %>% 
  group_by(started_hour, member_casual) %>% 
  slice_max(na.omit(route_count), n = 10) %>% 
  ungroup()

route_df
```

```{r}
basemap <- ggmap(get_stamenmap(
                c(left = min(route_df$start_lng, route_df$end_lng) - .05,
                  bottom = min(route_df$start_lat, route_df$end_lat) - .01,
                  right = max(route_df$start_lng, route_df$end_lng) + .05,
                  top = max(route_df$start_lat, route_df$end_lat)) + .01,
                  maptype = "toner-lite", zoom = 12))

 route_time_lapse = basemap +
 geom_curve(data = route_df,
 aes(x = start_lng, y = start_lat, xend = end_lng, yend = end_lat, color = member_casual, group = started_hour),    
 arrow = arrow(angle = 15, length = unit(0.3, "cm"), type = "closed"),
 alpha = 0.8, curvature = 0.25, inherit.aes = TRUE) +
 scale_size_continuous(range = c(1, 30)) +
 coord_cartesian() +
 labs(title = "Most Frequent Bike Routes", subtitle = "Hourly Time Lapse: {closest_state}") +
 guides(fill = guide_legend(title = "Rider Type")) +
 transition_states(started_hour, transition_length = 2, state_length = 2) +
  enter_fade() + 
  exit_shrink() +
  ease_aes('sine-in-out')

animate(route_time_lapse, duration = 45, height = 800, width = 600)

anim_save("route_time_lapse.gif")
```

```{r}
start_station_df <- bikeshare_df %>%
  filter(start_station_name != "" & end_station_name != "") %>%
  group_by(start_station_name) %>% 
  summarize(start_count = length(start_station_name))

end_station_df <- bikeshare_df %>%
  filter(end_station_name != "" & end_station_name != "") %>%
  group_by(end_station_name) %>% 
  summarize(end_count = length(end_station_name))

station_df <- start_station_df %>% 
  full_join(end_station_df, by = c("start_station_name" = "end_station_name")) %>% 
  replace_na(list(start_station_name = "unknown", start_count = 0, end_count = 0)) %>% 
  rename(station_name = start_station_name) %>% 
  mutate(total = start_count + end_count) %>% 
  slice_max(na.omit(total), n = 20)
  
station_df
```

```{r}
stations <- station_df$station_name

member_adjacency <- bikeshare_df %>% 
  filter(member_casual == "member" & start_station_name %in% stations & end_station_name %in% stations) %>% 
  group_by(start_station_name, end_station_name) %>% 
  summarize(count = length(end_station_name), .groups = "drop") %>% 
  rename(depart = start_station_name, arrive = end_station_name) %>% 
  pivot_wider(names_from = arrive, values_from = count)

chord_vector <- vector()
for (i in 1:nrow(member_adjacency)) {
  chord_vector <- c(chord_vector, member_adjacency[-1] %>% slice(i) %>% as.numeric())
}

chord_matrix <- matrix(chord_vector, nrow = nrow(member_adjacency), ncol = nrow(member_adjacency), byrow = TRUE)

colors_swatches <- c("#a9a9a9", "#778899", "#696969", "#ffffd0", "#ffff85", "#ffd700", "#ffa808", "#ff7f50", "#deb887", "#da8520", "#8fbc8f", "#32cd32", "#90ee90", "#afeeee", "#48d1cc", "#00a3a3", "#00bfff", "#1e90ff", "#4169e1", "#3b3bff")

stations <- colnames(member_adjacency)[-1]

dimnames(chord_matrix) <- list(depart = stations, arrive = stations)

chorddiag(chord_matrix, groupColors = colors_swatches, groupnameFontsize = 10, groupnamePadding = 5, showTicks = FALSE)
```

```{r}
casual_adjacency <- bikeshare_df %>% 
  filter(member_casual == "casual" & start_station_name %in% stations & end_station_name %in% stations) %>% 
  group_by(start_station_name, end_station_name) %>% 
  summarize(count = length(end_station_name), .groups = "drop") %>% 
  rename(depart = start_station_name, arrive = end_station_name) %>% 
  pivot_wider(names_from = arrive, values_from = count)

chord_vector <- vector()
for (i in 1:nrow(casual_adjacency)) {
  chord_vector <- c(chord_vector, casual_adjacency[-1] %>% slice(i) %>% as.numeric())
}

chord_matrix <- matrix(chord_vector, nrow = nrow(casual_adjacency), ncol = nrow(casual_adjacency), byrow = TRUE)

colors_swatches <- c("#a9a9a9", "#778899", "#696969", "#ffffd0", "#ffff85", "#ffd700", "#ffa808", "#ff7f50", "#deb887", "#da8520", "#8fbc8f", "#32cd32", "#90ee90", "#afeeee", "#48d1cc", "#00a3a3", "#00bfff", "#1e90ff", "#4169e1", "#3b3bff")

stations <- colnames(casual_adjacency)[-1]

dimnames(chord_matrix) <- list(depart = stations, arrive = stations)

chorddiag(chord_matrix, groupColors = colors_swatches, groupnameFontsize = 10, groupnamePadding = 5, showTicks = FALSE)
```

```{r}
freq_routes_df <- bikeshare_df %>%
  filter(start_station_name != "" & end_station_name != "" & start_station_name != end_station_name) %>%
  mutate(route_name = ifelse(start_station_name < end_station_name, paste(start_station_name, end_station_name, sep = " - "), paste(end_station_name, start_station_name, sep = " - "))) %>%
  with_groups(c(route_name, month_of_year), mutate, route_count = length(month_of_year)) %>%
  group_by(month_of_year, route_name, member_casual) %>%
  summarize(subgroup_route_count = length(month_of_year), route_count = first(route_count), .groups = "drop") %>%
  group_by(month_of_year) %>% 
  slice_max(na.omit(route_count), n = 10) %>% 
  ungroup()

temp_df <- freq_routes_df %>% filter(subgroup_route_count == route_count)

temp_df$subgroup_route_count <- 0L
temp_df$member_casual <-rep("casual", n = 5)
freq_routes_df <- bind_rows(freq_routes_df, temp_df) %>% arrange(month_of_year, route_name, member_casual)

freq_routes_df
```

```{r}
month_mapper <- c(paste(month.abb[c(4:12)], 2020), paste(month.abb[c(1:3)], 2021))
names(month_mapper) <- levels(bikeshare_df$month_of_year)

ggplot(freq_routes_df, aes(y = route_name, x = subgroup_route_count, fill = member_casual)) +
  geom_bar(position = "dodge", stat = "identity") + 
  facet_grid(month_of_year ~ ., scales = "free", space = "free", labeller = as_labeller(month_mapper)) +
  xlab("Total Number of Trips (bidirectional)") +
  ylab(" ") +
  guides(fill=guide_legend(title="Rider Type")) + 
  labs(title = "Most Frequent Monthly Bike Routes (Bidirectional)")
```

