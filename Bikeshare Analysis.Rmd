---
title: "Bike Sharing Analysis"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Cmd+Shift+Enter*. 

```{r}
library(knitr)

project_folder <- "./Chicago_Bike_Share"

if (!dir.exists(project_folder)) {
  dir.create(project_folder)
}

knitr::opts_knit$set(root.dir = project_folder)
```

```{r}
packages <- c("dplyr", "DBI", "skimr", "stringr", "tibble", "lubridate", "geosphere", "ggplot2", "ggmap", "ggthemes", "gridExtra", "gganimate", "modeest")

install.packages(setdiff(packages, rownames(installed.packages())))

for (pkg in packages) {
  library(pkg, character.only = TRUE, warn.conflicts = FALSE, quietly = TRUE)
}
```

```{r}
url_start <- 'https://divvy-tripdata.s3.amazonaws.com/'
dates <- format(seq(as.Date("2020/4/1"), as.Date("2021/3/1"), "months"), "%Y%m")
url_end <- '-divvy-tripdata.zip'
full_url <- vector()

for (date in dates) {
  full_url <- append(full_url, paste(url_start, date, url_end, sep=''))
}

filenames <- vector()
start_index <- nchar(url_start) + 1L

for (url_link in full_url) {
  end_index <- nchar(url_link) - 4L
  filenames <- append(filenames, paste(substr(url_link, start_index, end_index),'.csv',sep=''))
}
```

```{r}
connect <- dbConnect(RSQLite::SQLite(), "local_sqldb.sqlite", extended_type=TRUE)

field_names <-  c("ride_id" = "TEXT",
    "rideable_type" = "TEXT",
    "started_at" = "TIMESTAMP",
    "ended_at" = "TIMESTAMP",
    "start_station_name" = "TEXT",
    "start_station_id"  = "INTEGER",
    "end_station_name" = "TEXT",
    "end_station_id" = "INTEGER",
    "start_lat" = "REAL",
    "start_lng" = "REAL",
    "end_lat" = "REAL",
    "end_lng" = "REAL",
    "member_casual" = "TEXT")

if (!dbExistsTable(connect, "bikeshare")) {
  dbCreateTable(connect, "bikeshare", field_names)
}

dbDisconnect(connect)
```

```{r}
connect <- dbConnect(RSQLite::SQLite(), "local_sqldb.sqlite", extended_type=TRUE)

query <- dbSendQuery(connect, 'select * from bikeshare')

if (nrow(dbFetch(query, n = 10)) == 0) {
  for (i in seq(full_url)) {
    temp <- tempfile()
    url_link <- full_url[i]
    csv_file <- filenames[i]
    download.file(url_link, temp)
    data <- read.csv(unz(temp, csv_file))
    dbAppendTable(connect, "bikeshare", data)
    unlink(temp)
  }
}

dbClearResult(query)
dbDisconnect(connect)
```

```{r}
connect <- dbConnect(RSQLite::SQLite(), "local_sqldb.sqlite", extended_type=TRUE)

bikeshare_df <- dbReadTable(connect, "bikeshare")
head(bikeshare_df)

dbDisconnect(connect)
```

```{r}
skim(bikeshare_df)
```

```{r}
print(paste("There are", nrow(bikeshare_df[!complete.cases(bikeshare_df),]), "rows with missing values, excluding empty fields.", sep = " "))
```

```{r}
bikeshare_df %>%
  filter(is.na(start_station_id)) %>% 
  head()
```

```{r}
bikeshare_df %>%
  filter(start_station_name == '') %>% 
  arrange(started_at) %>% 
  head()
```

```{r}
bikeshare_df %>%
  filter(start_station_name == '') %>% 
  arrange(desc(started_at)) %>% 
  head()
```

```{r}
bikeshare_df %>%
  filter(start_station_name == '' & !is.na(start_station_id)) %>% 
  arrange(started_at) %>% 
  head()
```

```{r}
bikeshare_df %>%
  filter(start_station_name == '' & !is.na(start_station_id)) %>% 
  arrange(desc(started_at)) %>% 
  head()
```

```{r}
bikeshare_df %>%
  filter(start_station_name != '' & start_station_id == 0) %>% 
  summarize(name_count = n_distinct(start_station_name)) 
```

```{r}
bikeshare_df %>%
  filter(start_station_name == '' & !is.na(start_station_id) & start_station_id != 0) %>% 
  head()
```

```{r}
bikeshare_df %>%
  filter(end_station_name == '' & !is.na(end_station_id) & end_station_id != 0) %>% 
  head()
```

```{r}
bikeshare_df %>%
  filter(start_station_name == '' & rideable_type != 'electric_bike') %>% 
  head()
```

```{r}
bikeshare_df %>% 
  filter(end_station_name == '' & rideable_type != 'electric_bike') %>% 
  head()
```

```{r}
search_result <- bikeshare_df %>% 
  filter(!is.na(start_station_id) & start_station_id != 0) %>%
  group_by(start_station_id) %>%
  summarize(count_station_name = n_distinct(start_station_name)) %>% 
  filter(count_station_name > 1)

search_result
```

```{r}
bikeshare_df %>% 
  select(start_station_id, start_station_name) %>% 
  filter(start_station_id %in% search_result$start_station_id) %>%
  group_by(start_station_id, start_station_name) %>% 
  summarize()
```

```{r}
search_result <- bikeshare_df %>% 
  filter(!is.na(start_station_name) & start_station_id != 0) %>%
  group_by(start_station_name) %>%
  summarize(count_station_id = n_distinct(start_station_id)) %>% 
  filter(count_station_id > 1)

search_result
```

```{r}
bikeshare_df %>% 
  select(start_station_id, start_station_name) %>% 
  filter(start_station_name %in% search_result$start_station_name) %>%
  group_by(start_station_name, start_station_id) %>% 
  summarize()
```

```{r}
bikeshare_df %>% 
  filter(start_station_name == end_station_name & start_station_id != 0) %>% 
  head()
```

```{r}
bikeshare_df <- bikeshare_df %>% 
  mutate(month_of_year = format(as.Date(started_at), "%m"), day_of_week = weekdays(as.Date(started_at)), hour_of_day = hour(as_datetime(started_at)), quarter_of_year = quarter(as.Date(started_at), with_year = TRUE))

head(bikeshare_df)
```

```{r}
mile_conversion = 0.0006213711922373339

bikeshare_df <- mutate(bikeshare_df, trip_duration = as.period(interval(ymd_hms(started_at, tz = "America/Chicago"), ymd_hms(ended_at, tz = "America/Chicago"))))
bikeshare_df <- mutate(bikeshare_df, trip_distance = distHaversine(cbind(start_lng, start_lat),
                cbind(end_lng, end_lat)) * mile_conversion)

head(bikeshare_df)
```

```{r}
ggplot(bikeshare_df  %>% filter(start_station_name == end_station_name & start_station_id != 0), aes(x = trip_duration)) + geom_histogram(binwidth = 1) +
  scale_y_continuous(trans='log2') +
  xlab("Duration (minutes)") +
  ylab("Logarithmic Number of Trips") +
  ggtitle("Logarithmic Count of Trips Starting and Ending at the Same Location")
```

```{r}
bikeshare_df %>% 
  filter(trip_duration < period(c(0, 0), c('second', 'minute'))) %>% 
  arrange(trip_duration)
```

```{r}
bikeshare_df <- bikeshare_df %>% 
  filter(trip_duration > period(c(0, 0), c('second', 'minute')))

bikeshare_df %>% arrange(desc(trip_duration))
```

```{r}
bikeshare_df <- bikeshare_df %>% 
  filter(start_station_name != end_station_name | (start_station_name == end_station_name & trip_duration > period(c(0, 5), c('second', 'minute'))))
```

```{r}
ggplot(bikeshare_df, aes(x = rideable_type, fill = member_casual)) +
  geom_histogram(stat="count") +
  stat_count(aes(y=..count.., label=..count..), geom="text", vjust=1.2, size=3, alpha = .7) +
  xlab("") +
  ylab("Total number of trips") +
  guides(fill=guide_legend(title="Rider Type")) + 
  theme(panel.grid.minor.x=element_blank(), panel.grid.major.x=element_blank())
```

```{r}
daily_trip_df <- bikeshare_df %>%
  select(started_at, day_of_week) %>%
  group_by(as.Date(started_at)) %>%
  summarize(daily_trip_count = length(started_at), day_of_week = first(day_of_week))

daily_trip_df$day_of_week <- factor(daily_trip_df$day_of_week, levels = weekdays(x=as.Date(seq(7), origin='1950-01-01')))

ggplot(daily_trip_df, aes(x = day_of_week, y = daily_trip_count)) + 
  geom_violin(color = 'navy') +
  geom_dotplot(binaxis = 'y', stackdir = 'center', dotsize = .4, color = "grey", alpha = .7) +
  xlab("") +
  ylab("Total Number of Daily Trips") +
  theme(panel.grid.minor.x = element_blank(), panel.grid.major.x = element_blank())
```

```{r}
daily_trip_df <- bikeshare_df %>%
  filter(member_casual == 'member') %>%
  select(started_at, day_of_week) %>%
  group_by(as.Date(started_at)) %>%
  summarize(daily_trip_count = length(started_at), day_of_week = first(day_of_week))

daily_trip_df$day_of_week <- factor(daily_trip_df$day_of_week, levels = weekdays(x=as.Date(seq(7), origin='1950-01-01')))

ggplot(daily_trip_df, aes(x = day_of_week, y = daily_trip_count)) + 
  geom_violin(color = 'navy', fill = 'turquoise', alpha = .9) +
  geom_dotplot(binaxis = 'y', stackdir = 'center', dotsize = .4, color = "grey", alpha = .7) +
  xlab("") +
  ylab("Total Number of Daily Trips") +
  theme(panel.grid.minor.x = element_blank(), panel.grid.major.x = element_blank())
```

```{r}
daily_trip_df <- bikeshare_df %>%
  filter(member_casual == 'casual') %>%
  select(started_at, day_of_week) %>%
  group_by(as.Date(started_at)) %>%
  summarize(daily_trip_count = length(started_at), day_of_week = first(day_of_week))

daily_trip_df$day_of_week <- factor(daily_trip_df$day_of_week, levels = weekdays(x=as.Date(seq(7), origin='1950-01-01')))

ggplot(daily_trip_df, aes(x = day_of_week, y = daily_trip_count)) + 
  geom_violin(color = 'navy', fill = 'coral', alpha = .9) +
  geom_dotplot(binaxis = 'y', stackdir = 'center', dotsize = .4, color = "grey", alpha = .7) +
  xlab("") +
  ylab("Total Number of Daily Trips") +
  theme(panel.grid.minor.x = element_blank(), panel.grid.major.x = element_blank())
```

```{r}
hourly_trip_df <- bikeshare_df %>%
  select(started_at) %>%
  group_by(date = as.Date(started_at), hour = substr(started_at, 12, 13)) %>%
  summarize(daily_trip_count = length(started_at))

hourly_trip_df$hour <- paste(hourly_trip_df$hour, ":00", sep = "")

ggplot(hourly_trip_df, aes(y = hour, x = daily_trip_count)) + 
  geom_boxplot(color = "navy", alpha = .7) +
  scale_y_discrete(limits=rev) +
  xlab("Total Number of Daily Trips") +
  ylab("Hour of Day") +
  theme(panel.grid.minor.y=element_blank(), panel.grid.major.y=element_blank())
```

```{r}
hourly_trip_df <- bikeshare_df %>%
  filter(member_casual == "member") %>% 
  select(started_at) %>%
  group_by(date = as.Date(started_at), hour = substr(started_at, 12, 13)) %>%
  summarize(daily_trip_count = length(started_at))

hourly_trip_df$hour <- paste(hourly_trip_df$hour, ":00", sep = "")

ggplot(hourly_trip_df, aes(y = hour, x = daily_trip_count)) + 
  geom_boxplot(color = "navy", alpha = .9, fill = "turquoise") +
  scale_y_discrete(limits=rev) +
  xlab("Total Number of Daily Trips") +
  ylab("Hour of Day") +
  theme(panel.grid.minor.y=element_blank(), panel.grid.major.y=element_blank())
```

```{r}
hourly_trip_df <- bikeshare_df %>%
  filter(member_casual == "casual") %>% 
  select(started_at) %>%
  group_by(date = as.Date(started_at), hour = substr(started_at, 12, 13)) %>%
  summarize(daily_trip_count = length(started_at))

hourly_trip_df$hour <- paste(hourly_trip_df$hour, ":00", sep = "")

ggplot(hourly_trip_df, aes(y = hour, x = daily_trip_count)) + 
  geom_boxplot(color = "navy", alpha = .9, fill = "coral") +
  scale_y_discrete(limits=rev) +
  xlab("Total Number of Daily Trips") +
  ylab("Hour of Day") +
  theme(panel.grid.minor.y=element_blank(), panel.grid.major.y=element_blank())
```

```{r}
modified_bikeshare_df <- bikeshare_df %>% 
  filter(trip_duration <= period(c(0, 0, 12), c('second', 'minute', 'hour')))
```


```{r}
ggplot(modified_bikeshare_df, aes(x = as.numeric(as.duration(trip_duration), "minutes"), fill = member_casual)) +
  geom_histogram(binwidth = 10) +
  scale_y_continuous(trans='log2') +
  facet_wrap(~ member_casual) +
  xlab("Duration of Trip (minutes)") +
  ylab("Logarithmic Number of Trips") +
  guides(fill=guide_legend(title="Rider Type")) + 
  theme(panel.grid.minor.x=element_blank(), panel.grid.major.x=element_blank())
```


```{r}
start_station_df <- bikeshare_df %>% 
  filter(start_station_name != "") %>% 
  group_by(member_casual, start_station_name) %>%
  summarize(trip_count = length(start_station_name), start_lat = mlv(start_lat, method = "mfv"), start_lng = mlv(start_lng, method = "mfv")) %>% 
  arrange(desc(trip_count)) %>% 
  distinct(member_casual, start_station_name, .keep_all = TRUE) %>%
  ungroup

start_station_df
```

```{r}
basemap <- ggmap(get_stamenmap(c(left = min(start_station_df$start_lng) - .05,
                  bottom = min(start_station_df$start_lat) - .01,
                  right = max(start_station_df$start_lng) + .05,
                  top = max(start_station_df$start_lat)) + .01,
                  maptype = "toner-lite", zoom = 11))

basemap + 
  geom_point(aes(x = start_lng, y = start_lat), data = start_station_df, color = "navy", size = 0.5)
```

```{r}
top_member_start_station_df <- start_station_df %>% 
  filter(member_casual == "member") %>%
  slice_max(trip_count, n = 10)

top_casual_start_station_df <- start_station_df %>% 
  filter(member_casual == "casual") %>%
  slice_max(trip_count, n = 10)

basemap + 
  geom_point(aes(x = start_lng, y = start_lat, size = trip_count), data = top_member_start_station_df, color = "turquoise", alpha = .7) + 
  geom_point(aes(x = start_lng, y = start_lat, size = trip_count), data = top_casual_start_station_df, color = "coral", alpha = .7) +
  facet_wrap(~ member_casual)
```

```{r}
end_station_df <- bikeshare_df %>% 
  filter(end_station_name != "") %>% 
  group_by(member_casual, end_station_name) %>%
  summarize(trip_count = length(end_station_name), end_lat = mlv(end_lat, method = "mfv"), end_lng = mlv(end_lng, method = "mfv")[1]) %>% 
  arrange(desc(trip_count)) %>% 
  distinct(member_casual, end_station_name, .keep_all = TRUE) %>%
  ungroup

end_station_df
```

```{r}
top_member_end_station_df <- end_station_df %>% 
  filter(member_casual == "member") %>%
  slice_max(trip_count, n = 10)

top_casual_end_station_df <- end_station_df %>% 
  filter(member_casual == "casual") %>%
  slice_max(trip_count, n = 10)

basemap + 
  geom_point(aes(x = end_lng, y = end_lat, size = trip_count), data = top_member_end_station_df, color = "turquoise", alpha = .7) + 
  geom_point(aes(x = end_lng, y = end_lat, size = trip_count), data = top_casual_end_station_df, color = "coral", alpha = .7) +
  facet_wrap(~ member_casual)
```

```{r}
route_df <- bikeshare_df %>%
  filter(start_station_name != "" & end_station_name != "" & start_station_name != end_station_name) %>% 
  with_groups(start_station_name, mutate, std_start_lat = mlv(start_lat, method = "mfv")[1], std_start_lng = mlv(start_lng, method = "mfv")[1]) %>% 
  with_groups(end_station_name, mutate, std_end_lat = mlv(end_lat, method = "mfv")[1], std_end_lng = mlv(end_lng, method = "mfv")[1]) %>% 
  group_by(started_hour = paste(substr(started_at, 12, 13), ":00:00", sep = ""), member_casual, std_start_lat, std_start_lng, std_end_lat, std_end_lng) %>% 
  summarize(route_count = length(std_end_lng)) %>% 
  ungroup %>% 
  arrange(desc(route_count)) %>% 
  group_by(started_hour, member_casual) %>% 
  slice(1:10) %>% 
  ungroup

route_df
```

```{r}
basemap <- ggmap(get_stamenmap(
                c(left = min(route_df$std_start_lng, route_df$std_end_lng) - .05,
                  bottom = min(route_df$std_start_lat, route_df$std_end_lat) - .01,
                  right = max(route_df$std_start_lng, route_df$std_end_lng) + .05,
                  top = max(route_df$std_start_lat, route_df$std_end_lat)) + .01,
                  maptype = "toner-lite", zoom = 11))

 route_time_lapse = basemap +
 geom_curve(data = route_df,
 aes(x = std_start_lng, y = std_start_lat, xend = std_end_lng, yend = std_end_lat, color = member_casual, group = started_hour),    
 arrow = arrow(angle = 15, length = unit(0.3, "cm"), type = "closed"),
 alpha = 0.8, curvature = 0.25, inherit.aes = TRUE) +
 scale_size_continuous(range = c(1, 30)) +
 coord_cartesian() +
 labs(title = "Most Frequent Bike Routes", subtitle = "Hourly Time Lapse: {closest_state}") +
 guides(fill = guide_legend(title = "Rider Type")) +
 transition_states(started_hour, transition_length = 2, state_length = 2) +
  enter_fade() + 
  exit_shrink() +
  ease_aes('sine-in-out')

animate(route_time_lapse, duration = 25)

anim_save("route_time_lapse.gif")
```

