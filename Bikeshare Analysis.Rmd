---
title: "Bike Sharing Analysis"
output:
  html_document:
    df_print: paged
---

## Cyclistic Bikeshare Analysis (May 4, 2021)

### Project Overview

This capstone project is part of the Google Data Analytics Professional Certificate on Coursera. The project assumes the following senerio. Being a junior data analyst on the marketing team at Cyclistic, a bike-sharing company in Chicago, **I was assigned to analyze how Cyclistic riders without annual membership, which is the group of interest for this project, use Cyclistic bikes differently than Cyclistic member riders.** Cyclistic riders without annual membership are referred to as casual riders. The financial analysts in the company have concluded that annual members are more profitable than casual riders. The director of marketing believes that  maximizing the number of annual members by converting casual riders into members is the right business strategy to ensure future growth and company's success. Rather than employing a broad-based marketing campaign, the director of marketing is considering using social media for a targeted marketing strategy.

### Project Goals
I'll be searching for patterns and trends in a variety of metrics that would show casual riders usage of Cyclistic bike differ from member usage of Cyclistic bike. Some of the metrics to consider are:

- Type of bike preference
- Day of week riding pattern
- Time of day riding pattern
- Duration of trip
- Most frequent stations
- Most frequent routes (start & end station pairs)

### Data Preparation

In the fictitious scenario, I get all my data internally but I'm refrained from using data that has any personal identifiable information. In reality, I'm provided with a public dataset online licensed by Motivate International. For this project, I'm using data that contains information about each ride, like time and location of the start and end of a bike trip, from April 2020 to March 2021. 

Please note that Covid 19 pandemic began in March 2020 in the US and Covid 19 lockdown and/or restrictive measures are in place for most of if not the entire period. This include shutting down of businesses that are not essential services, limited restaurant dining seating and travel restrictions. 

There are pros and cons about using this data. One of the benefits is that since travel is fairly restricted, the tourist usage of Cyclistic bike should be minimal. As there is no way to filter out based on personal information, using this data for analysis is ideal. However, how riders utilize Cyclistic bike during the pandemic may be different from how riders bike in normal times. Many people work from home and are no longer commuting daily. The patterns and trends from this data may not be representive of patterns and trends post-pandemic. This is something we need to keep in mind when looking at the results.

First, I wrote some code to create a new folder for this project, `Chicago_Bike_Share` in the current directory and switch directory to the new folder. Simply execute the code by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Cmd+Shift+Enter*. The results will appear beneath the code. Please run all the code chunks in order.

```{r}
library(knitr)

project_folder <- "./Chicago_Bike_Share"

if (!dir.exists(project_folder)) {
  dir.create(project_folder)
}

knitr::opts_knit$set(root.dir = project_folder)
```

Here, we install and import the packages needed for this project.

```{r}
packages <- c("dplyr", "DBI", "skimr", "stringr", "tidyr", "tibble", "lubridate", "geosphere", "ggplot2", "ggmap", "ggthemes", "gridExtra", "gganimate", "modeest", "chorddiag", "htmlwidgets")

install.packages(setdiff(packages, rownames(installed.packages())))

for (pkg in packages) {
  library(pkg, character.only = TRUE, warn.conflicts = FALSE, quietly = TRUE)
}
```

Now, we create a vector of web links where the data is located online. We also create a vector of CSV file names that correspond to each of the links.

```{r}
# create a vector of url links to the data
url_start <- 'https://divvy-tripdata.s3.amazonaws.com/'
dates <- format(seq(as.Date("2020/4/1"), as.Date("2021/3/1"), "months"), "%Y%m")
url_end <- '-divvy-tripdata.zip'
full_url <- vector()

for (date in dates) {
  full_url <- append(full_url, paste(url_start, date, url_end, sep=''))
}

# create a vector of CSV file name for each link
filenames <- vector()
start_index <- nchar(url_start) + 1L

for (url_link in full_url) {
  end_index <- nchar(url_link) - 4L
  filenames <- append(filenames, paste(substr(url_link, start_index, end_index),'.csv',sep=''))
}
```

Next, we create a new SQL database and add an empty table with the columns names.

```{r}
connect <- dbConnect(RSQLite::SQLite(), "local_sqldb.sqlite", extended_type=TRUE)

field_names <-  c("ride_id" = "TEXT",
    "rideable_type" = "TEXT",
    "started_at" = "TIMESTAMP",
    "ended_at" = "TIMESTAMP",
    "start_station_name" = "TEXT",
    "start_station_id"  = "INTEGER",
    "end_station_name" = "TEXT",
    "end_station_id" = "INTEGER",
    "start_lat" = "REAL",
    "start_lng" = "REAL",
    "end_lat" = "REAL",
    "end_lng" = "REAL",
    "member_casual" = "TEXT")

# checks to see that the table does not exist before creating
if (!dbExistsTable(connect, "bikeshare")) {
  dbCreateTable(connect, "bikeshare", field_names)
}

dbDisconnect(connect)
```

Now, we download and unzip the data, open the file in R and append the data in the SQL table that we just created.

```{r}
connect <- dbConnect(RSQLite::SQLite(), "local_sqldb.sqlite", extended_type=TRUE)

query <- dbSendQuery(connect, 'select * from bikeshare')

if (nrow(dbFetch(query, n = 10)) == 0) {
  for (i in seq(full_url)) {
    temp <- tempfile()
    url_link <- full_url[i]
    csv_file <- filenames[i]
    download.file(url_link, temp)
    data <- read.csv(unz(temp, csv_file))
    dbAppendTable(connect, "bikeshare", data)
    unlink(temp)
  }
}

dbClearResult(query)
dbDisconnect(connect)
```

We are now ready to read the whole table stored in our SQL database into R.

```{r}
connect <- dbConnect(RSQLite::SQLite(), "local_sqldb.sqlite", extended_type=TRUE)

bikeshare_df <- dbReadTable(connect, "bikeshare")
head(bikeshare_df)

dbDisconnect(connect)
```

Let's check out the metadata summary with skimr.

```{r}
skim(bikeshare_df)
```

There is so much useful information here. The table consist of 3,489,748 rows and 13 columns. 7 columns are of character data type and 6 are of numeric data type. None of the character type columns are unique. Upon further investigation, none of the columns are unique and therefore could not be used as a primary key for the SQL table. Although there are no missing values for character type columns, there are 122,175 empty strings found in start_station_name and 143,242 empty strings in end_station_id. As for numeric columns, start_station_id, end_station_id, end_lat, end_lng contain missing values.

Next, let's check to see how many rows contain at least a missing value.

```{r}
print(paste("There are", nrow(bikeshare_df[!complete.cases(bikeshare_df),]), "rows with missing values, excluding empty fields.", sep = " "))
```

We are going to first check on missing values starting with the start_id column.

```{r}
bikeshare_df %>%
  filter(is.na(start_station_id)) %>% 
  head()
```

It is curious that the date from started_at column begins from July 2020. The start_station_name column are empty while end_station_name and end_station_id contain some information.

I want to check out the empty strings at the start_station_name column to look for any pattern.

```{r}
bikeshare_df %>%
  filter(start_station_name == '') %>% 
  arrange(started_at) %>% 
  head()
```

The date from the started_at column also begins in July, 2020. Both start_station_id and start_station_name contains no information. I noticed that the rideble_type are all electic_bike just like the previous result.

I want to see the same results but for dates closest to the present.

```{r}
bikeshare_df %>%
  filter(start_station_name == '') %>% 
  arrange(desc(started_at)) %>% 
  head()
```

The dates are in March, 2021. The rideable_type entries are only electic_bike. However, both start_station_id and end_station_id are 0 while start_station_name and end_station_name are empty strings.

I'm beginning to think that there is a relationship between electric bikes and the missing data.

Next, we are going to examine observations with start_station_id but with no information on start_station_name.

```{r}
bikeshare_df %>%
  filter(start_station_name == '' & !is.na(start_station_id)) %>% 
  arrange(started_at) %>% 
  head()
```

The rideable_type entries are still electric_bike but the date starts from December 2021. While the start_station_id entries are 0, the values in the start_lat and the start_lng are not unique, indicating that start_station_id is not at one particular location.

Including start_station_id and end_station_id that are 0 can still be useful for some analyses while it can be problematic for other types of analyses. This is something that we also need to keep in mind.

Next, we are going to check out the same results but for dates closest to the present.

```{r}
bikeshare_df %>%
  filter(start_station_name == '' & !is.na(start_station_id)) %>% 
  arrange(desc(started_at)) %>% 
  head()
```

The same pattern keeps emerging: electic_bike for rideable_type, 0 for start_station_id and start_lat, start_lng do not contain unique values even as the start_station_id are the same.

We are going to examine the count of start_station_name that are not empty with start_station_id entries equal to 0.

```{r}
bikeshare_df %>%
  filter(start_station_name != '' & start_station_id == 0) %>% 
  summarize(name_count = n_distinct(start_station_name)) 
```

This is further confirmation that station_id 0 is not at some specific location. Using station_name would be a better choice for analysis than using station_id

The following 2 code chunks check to see if there are any station_id that is not 0 or missing that have empty string for station_name

```{r}
bikeshare_df %>%
  filter(start_station_name == '' & !is.na(start_station_id) & start_station_id != 0) %>% 
  head()
```

```{r}
bikeshare_df %>%
  filter(end_station_name == '' & !is.na(end_station_id) & end_station_id != 0) %>% 
  head()
```

If the station_id is not 0 or missing, the station_name is not an empty string.

Now, let's run the following 2 code chunks to check if there are any rows where the rideable_type is not electric_bike and the station_name is an empty string.

```{r}
bikeshare_df %>%
  filter(start_station_name == '' & rideable_type != 'electric_bike') %>% 
  head()
```

```{r}
bikeshare_df %>% 
  filter(end_station_name == '' & rideable_type != 'electric_bike') %>% 
  head()
```

The results is quite unexpected. There are no classic_bike or docked_bike with empty start_station_name string but there are non electric_bike with empty end_station_name string. Curiously enough, the end_lat and end_lng are also misiing but not ended_at for rows with empty end_station_name string. I don't know what to make of this subset.

Next, let's check which start_station_id have more than one start_station_name.

```{r}
search_result <- bikeshare_df %>% 
  filter(!is.na(start_station_id) & start_station_id != 0) %>%
  group_by(start_station_id) %>%
  summarize(count_station_name = n_distinct(start_station_name)) %>% 
  filter(count_station_name > 1)

search_result
```

There are 23 start_station_id with 2 different names.

Let's check our the start_station_name for these station_id.

```{r}
bikeshare_df %>% 
  select(start_station_id, start_station_name) %>% 
  filter(start_station_id %in% search_result$start_station_id) %>%
  group_by(start_station_id, start_station_name) %>% 
  summarize()
```

It looks like some stations are moved to a different location while some temperary stations became permanent.

We are going to look at start_station_name with more than one start_station_id

```{r}
search_result <- bikeshare_df %>% 
  filter(!is.na(start_station_name) & start_station_id != 0) %>%
  group_by(start_station_name) %>%
  summarize(count_station_id = n_distinct(start_station_id)) %>% 
  filter(count_station_id > 1)

search_result
```

There are 279 start_station_name with two different start_station_id.

Let's find out the start_station_id for the station_name.

```{r}
bikeshare_df %>% 
  select(start_station_id, start_station_name) %>% 
  filter(start_station_name %in% search_result$start_station_name) %>%
  group_by(start_station_name, start_station_id) %>% 
  summarize(.groups = "drop")
```

There stations have one thing in common. One of the station is 2-3 digits and the other is 5 digits.

Let's check to see if there are any rows where start_station_name and end_station_name are the same.

```{r}
bikeshare_df %>% 
  filter(start_station_name == end_station_name & start_station_id != 0) %>% 
  head()
```

It maybe worth checking these round trips later.

### Engineering Features

Let's create some features based on started_at.

```{r}
bikeshare_df <- bikeshare_df %>% 
  mutate(month_of_year = as.factor(paste(format(as.Date(started_at), "%Y"), ".", format(as.Date(started_at), "%m"), sep = "")), 
         day_of_week = weekdays(as.Date(started_at)), 
         hour_of_day = as.factor(paste(str_pad(hour(as_datetime(started_at)), 2, "left", pad = 0), "00", sep = ":")), 
         quarter_of_year = quarter(as.Date(started_at), with_year = TRUE))

head(bikeshare_df)
```

We now create two new features about the trip: trip_duraton and trip_distance.

```{r}
mile_conversion = 0.0006213711922373339

bikeshare_df <- mutate(bikeshare_df, trip_duration = as.period(interval(ymd_hms(started_at, tz = "America/Chicago"), ymd_hms(ended_at, tz = "America/Chicago"))))
bikeshare_df <- mutate(bikeshare_df, trip_distance = distHaversine(cbind(start_lng, start_lat),
                cbind(end_lng, end_lat)) * mile_conversion)

head(bikeshare_df)
```

Let's now check out the histogram of the trip_duration that we just created.

```{r}
ggplot(bikeshare_df  %>% filter(start_station_name == end_station_name & start_station_id != 0), aes(x = as.numeric(as.duration(trip_duration), "minutes"))) + geom_histogram(binwidth = 5) +
  xlim(-180, 1600) +
  scale_y_continuous(trans='log2') +
  xlab("Duration (minutes)") +
  ylab("Logarithmic Number of Trips") +
  ggtitle("Logarithmic Count of Trips Starting and Ending at the Same Location")
```

The distribution is skewed to the right and it appears that there are some trips with negative trip_duration.

```{r}
bikeshare_df %>% 
  filter(trip_duration < period(c(0, 0), c('second', 'minute'))) %>% 
  arrange(trip_duration)
```

My first intuition is that this is the result of time change that happens twice a year. The results above show many different dates and this is clearly bad data.

We are going to remove the rows of bad data.

```{r}
bikeshare_df <- bikeshare_df %>% 
  filter(trip_duration > period(c(0, 0), c('second', 'minute')))

bikeshare_df %>% arrange(desc(trip_duration))
```

In additional, we'll remove trips that are less than five minutes where the start_station_name and the end_station_name are the same.

```{r}
bikeshare_df <- bikeshare_df %>% 
  filter(start_station_name != end_station_name | (start_station_name == end_station_name & trip_duration > period(c(0, 5), c('second', 'minute'))))
```

### Data Visualization

The first graph we are going to build will show member and casual riders usage of the different bike type.

```{r}
ggplot(bikeshare_df, aes(x = rideable_type, fill = member_casual)) +
  geom_histogram(stat = "count", alpha = .8) +
  stat_count(aes(y = ..count.., label = ..count..), geom = "text", vjust = 1.2, size =3, alpha = .8) +
  xlab(" ") +
  ylab("Total number of trips") +
  guides(fill=guide_legend(title="Rider Type")) + 
  theme(panel.grid.minor.x=element_blank(), panel.grid.major.x=element_blank()) +
  ggtitle("Rider Usage by Type of Bike")
```

Overall, docked_bike has the highest number of trip of the three different bike types. It is true for both groups of riders. However, the initial exploration of data hints that electric_bike may have been a new addition to the bike fleet. The empty station_name string and missing station_id may have been due to the addition of new bike stations for electric bikes. 

Next, let's build a bar chart to show the average trip duration of member and casual riders for the three different bike types.

```{r}
ggplot(bikeshare_df, aes(x = rideable_type, y = as.numeric(as.duration(trip_duration), "minutes"), fill = member_casual)) +
  geom_bar(position = "dodge", stat = "summary", fun = "mean", alpha = .8) +
  stat_summary(aes(label = round(..y.., 2)), fun = "mean", geom = "text", vjust = -0.5, position = position_dodge(0.9), size = 3, alpha = .8) +
  xlab(" ") +
  ylab("Average Duration of Trip (minutes)") +
  guides(fill = guide_legend(title = "Rider Type")) + 
  theme(panel.grid.minor.x = element_blank(), panel.grid.major.x = element_blank()) +
  ggtitle("Average Trip Duration by Type of Bike")
```

While the average trip duration is roughly the same for member riders at about 15 minutes, the average time casual riders spend on the three different bikes varies much more. On average, casual riders spend the most time on docked_bike, 52 minutes, and least on electric_bike, 22 minutes.

Let's now check out how the total number of trips vary by the day of week.

```{r}
daily_trip_df <- bikeshare_df %>%
  select(started_at, day_of_week) %>%
  group_by(as.Date(started_at)) %>%
  summarize(daily_trip_count = length(started_at), day_of_week = first(day_of_week))

daily_trip_df$day_of_week <- factor(daily_trip_df$day_of_week, levels = weekdays(x=as.Date(seq(7), origin='1950-01-01')))

ggplot(daily_trip_df, aes(x = day_of_week, y = daily_trip_count)) + 
  geom_violin(color = 'navy') +
  geom_dotplot(binwidth = 750, binaxis = 'y', stackdir = 'center', dotsize = .5, color = "grey", alpha = .7) +
  xlab("") +
  ylab("Daily Total Number of Trips") +
  theme(panel.grid.minor.x = element_blank(), panel.grid.major.x = element_blank()) +
  ggtitle("Daily Trip Count by Day of Week")
```

There are a few Saturdays during the twelve month period with daily trip totals higher than any other day of the week. Tuesday, Wednesday and Thursday have similar distribution of daily trip totals.

We are now constructing the same plot for just the member group.

```{r}
daily_trip_df <- bikeshare_df %>%
  filter(member_casual == 'member') %>%
  select(started_at, day_of_week) %>%
  group_by(as.Date(started_at)) %>%
  summarize(daily_trip_count = length(started_at), day_of_week = first(day_of_week))

daily_trip_df$day_of_week <- factor(daily_trip_df$day_of_week, levels = weekdays(x=as.Date(seq(7), origin='1950-01-01')))

ggplot(daily_trip_df, aes(x = day_of_week, y = daily_trip_count)) + 
  geom_violin(color = 'navy', fill = 'turquoise', alpha = .8) +
  geom_dotplot(binwidth = 750, binaxis = 'y', stackdir = 'center', dotsize = .2, color = "grey", alpha = .7) +
  xlab("") +
  ylab("Daily Total Number of Trips") +
  theme(panel.grid.minor.x = element_blank(), panel.grid.major.x = element_blank()) +
  ggtitle("Daily Member Trip Count by Day of Week")
```

Overall, the distribution of the daily trip totals for the different days of the week looks similar with just a slight variation.

Here is the plot for the casual riders.

```{r}
daily_trip_df <- bikeshare_df %>%
  filter(member_casual == 'casual') %>%
  select(started_at, day_of_week) %>%
  group_by(as.Date(started_at)) %>%
  summarize(daily_trip_count = length(started_at), day_of_week = first(day_of_week))

daily_trip_df$day_of_week <- factor(daily_trip_df$day_of_week, levels = weekdays(x=as.Date(seq(7), origin='1950-01-01')))

ggplot(daily_trip_df, aes(x = day_of_week, y = daily_trip_count)) + 
  geom_violin(color = 'navy', fill = 'coral', alpha = .8) +
  geom_dotplot(binwidth = 750, binaxis = 'y', stackdir = 'center', dotsize = .3, color = "grey", alpha = .7) +
  xlab("") +
  ylab("Daily Total Number of Trips") +
  theme(panel.grid.minor.x = element_blank(), panel.grid.major.x = element_blank()) +
  ggtitle("Daily Casual Trip Count by Day of Week")
```

With the exception on one Monday, there are a few Fridays, Saturdays and Sundays that is higher than the rest of the week. Casual riders are more likely to bike on weekends.

The following chart breaks down the count daily count of trips by hour of day.

```{r}
hourly_trip_df <- bikeshare_df %>%
  group_by(date = as.Date(started_at), hour_of_day) %>%
  summarize(hourly_trip_count = length(hour_of_day), .groups = "drop")

ggplot(hourly_trip_df, aes(y = hour_of_day, x = hourly_trip_count)) + 
  geom_boxplot(color = "navy", alpha = .7) +
  scale_y_discrete(limits=rev) +
  xlab("Total Number of Trips") +
  ylab("Hour of Day") +
  theme(panel.grid.minor.y=element_blank(), panel.grid.major.y=element_blank()) +
ggtitle("Hourly Trip Count")
```

Most of the trips occur in the afternoon and early evening. The hour between 5pm - 6pm has the highest average count.

This is the hourly breakdown for member group.

```{r}
hourly_trip_df <- bikeshare_df %>%
  filter(member_casual == "member") %>% 
  group_by(date = as.Date(started_at), hour_of_day) %>%
  summarize(hourly_trip_count = length(hour_of_day), .groups = "drop")

ggplot(hourly_trip_df, aes(y = hour_of_day, x = hourly_trip_count)) + 
  geom_boxplot(color = "navy", alpha = .9, fill = "turquoise") +
  scale_y_discrete(limits=rev) +
  xlab("Total Number of Trips") +
  ylab("Hour of Day") +
  theme(panel.grid.minor.y=element_blank(), panel.grid.major.y=element_blank()) +
  ggtitle("Hourly Member Trip Count")
```

Now, we look at the chart for casual riders and compare the two groups.

```{r}
hourly_trip_df <- bikeshare_df %>%
  filter(member_casual == "casual") %>% 
  group_by(date = as.Date(started_at), hour_of_day) %>%
  summarize(hourly_trip_count = length(hour_of_day), .groups = "drop")

ggplot(hourly_trip_df, aes(y = hour_of_day, x = hourly_trip_count)) + 
  geom_boxplot(color = "navy", alpha = .9, fill = "coral") +
  scale_y_discrete(limits=rev) +
  xlab("Total Number of Trips") +
  ylab("Hour of Day") +
  theme(panel.grid.minor.y=element_blank(), panel.grid.major.y=element_blank()) +
  ggtitle("Hourly Casual Trip Count")
```

Although, the two charts look relatively similar, there are subtle differences. There are more casual riders than members who ride the bike  late evenings and more member riders than casual riders who bike during the morning commute.

Here is a look at the histogram of the duration of trips by the two groups.

```{r}
modified_bikeshare_df <- bikeshare_df %>% 
  filter(trip_duration <= period(c(0, 0, 16), c('second', 'minute', 'hour')))
```

```{r}
ggplot(modified_bikeshare_df, aes(x = as.numeric(as.duration(trip_duration), "minutes"), fill = member_casual)) +
  geom_histogram(binwidth = 10, alpha = .8) +
  scale_y_continuous(trans='log2') +
  facet_wrap(~ member_casual) +
  xlab("Duration of Trip (minutes)") +
  ylab("Logarithmic Number of Trips") +
  guides(fill=guide_legend(title = "Rider Type")) + 
  theme(panel.grid.minor.x=element_blank(), panel.grid.major.x=element_blank()) +
  ggtitle("Logarithmic Count of Trips by Trip Duration")
```

This plot confirms that casual riders are more likely to take longer trips than members. 

We are now going to create a plot of the average distance travelled by the two groups for each month during the one year period. For optimal viewing, please open the plot in a new full-screen window.

```{r}
monthly_trip_df <- bikeshare_df %>%
  filter(!is.na(trip_distance)) %>% 
  group_by(month_of_year, member_casual) %>%
  summarize(grouped_average_distance = mean(trip_distance, na.rm = TRUE), grouped_std_dev = sd(trip_distance, na.rm = TRUE), .groups = "drop")

ggplot(monthly_trip_df, aes(x = month_of_year, y = grouped_average_distance, group = member_casual)) + 
  geom_line(aes(x = month_of_year, y = grouped_average_distance, color = member_casual, linetype = member_casual)) +
  geom_ribbon(aes(ymin = grouped_average_distance - grouped_std_dev, ymax = grouped_average_distance + grouped_std_dev, fill = member_casual), alpha = 0.2) +
  xlab(" ") +
  ylab("Average Trip Distance (miles)") +
  scale_x_discrete(labels = c(paste(month.abb[c(4:12)], 2020), paste(month.abb[c(1:3)], 2021))) +
  guides(color = guide_legend(title = "Rider Type"), fill = guide_legend(title = "Rider Type"), linetype = guide_legend(title = "Rider Type")) +
  ggtitle("Average Trip Distance by Month of Year")
```

On average, member riders travel farther between April and August last year than casual riders.

```{r}
start_station_df <- bikeshare_df %>% 
  filter(start_station_name != "") %>% 
  with_groups(start_station_name, mutate, start_lat = mlv(start_lat, method = "mfv")[1], start_lng = mlv(start_lng, method = "mfv")[1]) %>% 
  group_by(member_casual, start_station_name) %>%
  summarize(trip_count = length(start_station_name), start_lat = first(start_lat), start_lng = first(start_lng), .groups = "drop_last")
  
start_station_df
```

Let's build a map of where all the bike stations are located.

```{r}
basemap <- ggmap(get_stamenmap(c(left = min(start_station_df$start_lng) - .05,
                  bottom = min(start_station_df$start_lat) - .01,
                  right = max(start_station_df$start_lng) + .05,
                  top = max(start_station_df$start_lat)) + .01,
                  maptype = "toner-lite", zoom = 11))

basemap + 
  geom_point(aes(x = start_lng, y = start_lat), data = start_station_df, color = "navy", size = 0.5) +
  theme_nothing()
```

Here is a map of the 50 top bike stations where member and casual riders start the trip. For optimal viewing, please open the map in a new full-screen window.

```{r}
top_start_df <- start_station_df %>% 
  slice_max(trip_count, n = 50)

basemap <- ggmap(get_stamenmap(c(left = min(top_start_df$start_lng) - .05,
                  bottom = min(top_start_df$start_lat) - .01,
                  right = max(top_start_df$start_lng) + .05,
                  top = max(top_start_df$start_lat)) + .01,
                  maptype = "toner-lite", zoom = 13))

basemap + 
  geom_point(aes(x = start_lng, y = start_lat, size = trip_count, color = member_casual), data = top_start_df, alpha = .7) +
  facet_wrap(~ member_casual) +
  xlab(" ") +
  ylab(" ") +
  guides(size = "none", color = guide_legend(title="Rider Type")) +
  theme(axis.text = element_blank(), axis.ticks = element_blank(), axis.title = element_blank())
```

The bike stations are generally in the same area, downtown Chicago and neighborhoods like Lincoln Park and Lakeview on the Northside that are next to Lake Michigan. Notice the size of the circles for casual riders are generally smaller than member for bike stations on the Northside. This indicates that more member riders start the trip at these bike stations than casual riders.

Here is a graph of the names of the top 50 bike stations where members start the trip. For optimal viewing, please open the plot in a new full-screen window.

```{r}
member_start_df <- start_station_df %>% filter(member_casual == "member") %>% 
  slice_max(trip_count, n = 50)

label_meta <- member_start_df
number_of_bars <- nrow(label_meta)
angle <-  90 - 360 * (c(1:number_of_bars) - 0.5) / number_of_bars
label_meta$hjust <- ifelse(angle < -90, 1, 0)
label_meta$angle <- ifelse(angle < -90, angle + 180, angle)

ggplot(member_start_df, aes(x = as.factor(reorder(start_station_name, trip_count)), y = trip_count)) +
  geom_bar(stat = "identity", fill = "turquoise", alpha = .8) +
  ylim(-10000, 20000) +
  theme(axis.text = element_blank(), axis.ticks = element_blank(), axis.title = element_blank(), plot.margin = unit(rep(-1, 4), "cm")) +
  coord_polar() +
  geom_text(data = label_meta, aes(x = start_station_name, y = trip_count, label = paste(start_station_name, trip_count, sep = ": "), hjust = hjust), color = "black", fontface = "bold", alpha = 0.6, size = 2.5, angle = -label_meta$angle, inherit.aes = FALSE) 
```

Now, this is a graph of the names of the top 50 bike stations where casual riders start the trip. For optimal viewing, please open the plot in a new full-screen window.

```{r}
casual_start_df <- start_station_df %>% filter(member_casual == "casual") %>% 
  slice_max(trip_count, n = 50)

label_meta <- casual_start_df
number_of_bars <- nrow(label_meta)
angle <-  90 - 360 * (c(1:number_of_bars) - 0.5) / number_of_bars
label_meta$hjust <- ifelse(angle < -90, 1, 0)
label_meta$angle <- ifelse(angle < -90, angle + 180, angle)

ggplot(casual_start_df, aes(x = as.factor(reorder(start_station_name, trip_count)), y = trip_count)) +
  geom_bar(stat = "identity", fill = "coral", alpha = .8) +
  ylim(-15000, 27500) +
  xlab(" ") +
  ylab(" ") +
  theme(axis.text = element_blank(), axis.ticks = element_blank(), axis.title = element_blank(), plot.margin = unit(rep(-1, 4), "cm")) +
  coord_polar() +
  geom_text(data = label_meta, aes(x = start_station_name, y = trip_count, label = paste(start_station_name, trip_count, sep = ": "), hjust = hjust), color = "black", fontface = "bold", alpha = 0.6, size = 2.5, angle = -label_meta$angle, inherit.aes = FALSE)
```

The top member starting station, Clark St. & Elm St. is in the 8th place on the top casual starting station. The top casual starting station, Streeter Dr. & Grand Ave. is 50th on the top member starting station. The number of trips starting at the stations falls off quicker for casual riders than members.

```{r}
end_station_df <- bikeshare_df %>% 
  filter(end_station_name != "") %>% 
  with_groups(end_station_name, mutate, end_lat = mlv(end_lat, method = "mfv")[1], end_lng = mlv(end_lng, method = "mfv")[1]) %>% 
  group_by(member_casual, end_station_name) %>%
  summarize(trip_count = length(end_station_name), end_lat = first(end_lat), end_lng = first(end_lng), .groups = "drop_last")

end_station_df
```

Now, let's examine the 50 top stations that member and casual riders end the bike trip. For optimal viewing, please open the map in a new full-screen window.

```{r}
top_end_df <- end_station_df %>% 
  slice_max(trip_count, n = 50)

basemap <- ggmap(get_stamenmap(c(left = min(top_end_df$end_lng) - .05,
                  bottom = min(top_end_df$end_lat) - .01,
                  right = max(top_end_df$end_lng) + .05,
                  top = max(top_end_df$end_lat)) + .01,
                  maptype = "toner-lite", zoom = 13))

basemap + 
  geom_point(aes(x = end_lng, y = end_lat, size = trip_count, color = member_casual), data = top_end_df, alpha = .7) + 
  facet_wrap(~ member_casual) +
  xlab(" ") +
  ylab(" ") +
  guides(size = "none", color = guide_legend(title="Rider Type")) +
  theme(axis.text = element_blank(), axis.ticks = element_blank(), axis.title = element_blank())
```

The map looks very similar to that of starting bike stations.

We are going to create a plot comparing the top 50 ending member bike stations to the top 50 ending casual bike stations. For optimal viewing, please open the plot in a new full-screen window.

```{r}
member_end_df <- end_station_df %>% filter(member_casual == "member") %>% 
  slice_max(trip_count, n = 50)

casual_end_df <- end_station_df %>% filter(member_casual == "casual") %>% 
  slice_max(trip_count, n = 50)

empty_bar <- 5
empty_block <- bind_rows(head(member_end_df, n = empty_bar), head(casual_end_df, n = empty_bar))
empty_block[-1] <- na_if(empty_block[-1], empty_block[-1])
end_station_df <- bind_rows(member_end_df, casual_end_df, empty_block)
end_station_df <- end_station_df %>% arrange(member_casual)
end_station_df$id <- seq(1, nrow(end_station_df))

label_meta <- end_station_df
number_of_bars <- nrow(label_meta)
angle <-  90 - 360 * (c(1:number_of_bars) - 0.5) / number_of_bars
label_meta$hjust <- ifelse(angle < -90, 1, 0)
label_meta$angle <- ifelse(angle < -90, angle + 180, angle)

ggplot(end_station_df, aes(x = as.factor(id), y = trip_count, fill = member_casual)) +
  geom_bar(stat = "identity", alpha = .8) +
  ylim(-5000, 40000) +
  guides(fill=guide_legend(title="Rider Type")) +
  theme(axis.text = element_blank(), axis.ticks = element_blank(), axis.title = element_blank(), plot.margin = unit(rep(-1, 4), "cm")) +
  coord_polar() +
  geom_text(data = label_meta, aes(x = id, y = trip_count, label = paste(end_station_name, trip_count, sep = ": "), hjust = hjust), color = "black", fontface = "bold", alpha = 0.6, size = 2.5, angle = label_meta$angle, inherit.aes = FALSE) 
```

Similar observations of the top 50 starting station names are seen here.

It's time to create something exciting, an animated plot of the ten bike routes for the different hours of the day for the two groups. We are leaving out bike routes that start and end at the same station name. For optimal viewing, please open the map in a new full-screen window.

```{r}
route_df <- bikeshare_df %>%
  filter(start_station_name != "" & end_station_name != "" & start_station_name != end_station_name) %>% 
  with_groups(start_station_name, mutate, start_lat = mlv(start_lat, method = "mfv")[1], start_lng = mlv(start_lng, method = "mfv")[1]) %>% 
  with_groups(end_station_name, mutate, end_lat = mlv(end_lat, method = "mfv")[1], end_lng = mlv(end_lng, method = "mfv")[1]) %>% 
  group_by(started_hour = paste(hour_of_day, "00", sep = ":"), member_casual, start_lat, start_lng, end_lat, end_lng) %>% 
  summarize(route_count = length(end_lng), .groups = "drop") %>% 
  group_by(started_hour, member_casual) %>% 
  slice_max(na.omit(route_count), n = 10) %>% 
  ungroup()

route_df
```

For optimal viewing, please open the map in a new full-screen window.

```{r}
basemap <- ggmap(get_stamenmap(
                c(left = min(route_df$start_lng, route_df$end_lng) - .05,
                  bottom = min(route_df$start_lat, route_df$end_lat) - .01,
                  right = max(route_df$start_lng, route_df$end_lng) + .05,
                  top = max(route_df$start_lat, route_df$end_lat)) + .01,
                  maptype = "toner-lite", zoom = 12))

 route_time_lapse = basemap +
 geom_curve(data = route_df,
 aes(x = start_lng, y = start_lat, xend = end_lng, yend = end_lat, color = member_casual, group = started_hour),    
 arrow = arrow(angle = 15, length = unit(0.3, "cm"), type = "closed"),
 alpha = 0.8, curvature = 0.25, inherit.aes = TRUE) +
 scale_size_continuous(range = c(1, 30)) +
 coord_cartesian() +
 labs(title = "Most Frequent Bike Routes", subtitle = "Hourly Time Lapse: {closest_state}") +
 guides(fill = guide_legend(title = "Rider Type")) +
 transition_states(started_hour, transition_length = 2, state_length = 2) +
  enter_fade() + 
  exit_shrink() +
  ease_aes('sine-in-out')

animate(route_time_lapse, duration = 45, height = 800, width = 600)

anim_save("route_time_lapse.gif")
```

The top 10 most frequent routes for casual riders between 10am - 8pm are in downtown Chicago and along North Lake Shore Drive.

Let's create a new table of the top 20 station_name with the highest combined total count of trips starting and ending at that location.

```{r}
start_station_df <- bikeshare_df %>%
  filter(start_station_name != "" & end_station_name != "") %>%
  group_by(start_station_name) %>% 
  summarize(start_count = length(start_station_name))

end_station_df <- bikeshare_df %>%
  filter(end_station_name != "" & end_station_name != "") %>%
  group_by(end_station_name) %>% 
  summarize(end_count = length(end_station_name))

station_df <- start_station_df %>% 
  full_join(end_station_df, by = c("start_station_name" = "end_station_name")) %>% 
  replace_na(list(start_station_name = "unknown", start_count = 0, end_count = 0)) %>% 
  rename(station_name = start_station_name) %>% 
  mutate(total = start_count + end_count) %>% 
  slice_max(na.omit(total), n = 20)
  
station_df
```

This time, we are building an interactive chord diagram of the top 20 station_name for the member group that defines the route between pairs of station_name as a relationship or an edge of a graph. We are going to examine these connections to look for patterns. For optimal viewing, please open the plot in a new full-screen window.

```{r}
stations <- station_df$station_name

member_adjacency <- bikeshare_df %>% 
  filter(member_casual == "member" & start_station_name %in% stations & end_station_name %in% stations) %>% 
  group_by(start_station_name, end_station_name) %>% 
  summarize(count = length(end_station_name), .groups = "drop") %>% 
  rename(depart = start_station_name, arrive = end_station_name) %>% 
  pivot_wider(names_from = arrive, values_from = count)

chord_vector <- vector()
for (i in 1:nrow(member_adjacency)) {
  chord_vector <- c(chord_vector, member_adjacency[-1] %>% slice(i) %>% as.numeric())
}

chord_matrix <- matrix(chord_vector, nrow = nrow(member_adjacency), ncol = nrow(member_adjacency), byrow = TRUE)

colors_swatches <- c("#a9a9a9", "#778899", "#696969", "#ffffd0", "#ffff85", "#ffd700", "#ffa808", "#ff7f50", "#deb887", "#da8520", "#8fbc8f", "#32cd32", "#90ee90", "#afeeee", "#48d1cc", "#00a3a3", "#00bfff", "#1e90ff", "#4169e1", "#3b3bff")

stations <- colnames(member_adjacency)[-1]

dimnames(chord_matrix) <- list(depart = stations, arrive = stations)

chorddiag(chord_matrix, groupColors = colors_swatches, groupnameFontsize = 10, groupnamePadding = 5, showTicks = FALSE)
```

Let me quickly walk you through a few concepts of a chord diagram. Simply click or hover on the station_name you would like to examine and all the routes containing the station_name will be highlighted. The thickness of the ribbon represents the combined bidirectional count of trips between two station_name and the color of the ribbon represents the color of the station_name with the larger count of trips ending there. If you hover on a ribbon, an infobox will pop up showing the total trip count for both directions.

Take a few minutes to study the chord diagram above.

Next, we are going to create a chord diagram of the top 20 station_names for casual riders and compare the diagrams for insights. For optimal viewing, please open the plot in a new full-screen window.

```{r}
casual_adjacency <- bikeshare_df %>% 
  filter(member_casual == "casual" & start_station_name %in% stations & end_station_name %in% stations) %>% 
  group_by(start_station_name, end_station_name) %>% 
  summarize(count = length(end_station_name), .groups = "drop") %>% 
  rename(depart = start_station_name, arrive = end_station_name) %>% 
  pivot_wider(names_from = arrive, values_from = count)

chord_vector <- vector()
for (i in 1:nrow(casual_adjacency)) {
  chord_vector <- c(chord_vector, casual_adjacency[-1] %>% slice(i) %>% as.numeric())
}

chord_matrix <- matrix(chord_vector, nrow = nrow(casual_adjacency), ncol = nrow(casual_adjacency), byrow = TRUE)

colors_swatches <- c("#a9a9a9", "#778899", "#696969", "#ffffd0", "#ffff85", "#ffd700", "#ffa808", "#ff7f50", "#deb887", "#da8520", "#8fbc8f", "#32cd32", "#90ee90", "#afeeee", "#48d1cc", "#00a3a3", "#00bfff", "#1e90ff", "#4169e1", "#3b3bff")

stations <- colnames(casual_adjacency)[-1]

dimnames(chord_matrix) <- list(depart = stations, arrive = stations)

chorddiag(chord_matrix, groupColors = colors_swatches, groupnameFontsize = 10, groupnamePadding = 5, showTicks = FALSE)
```

By comparing the two chord diagrams, we notice that there are a few large ribbon `humps` in the diagram representing casual riders. This indicates that there are a large number of riders who started and ended the trip at the same station. We also can clearly see that the thickest ribbon between two different station_name can be found on the casual rider chord diagram between Streeter Dr. & Grand Ave. and Lake Shore Dr. & Monroe St.

```{r}
freq_routes_df <- bikeshare_df %>%
  filter(start_station_name != "" & end_station_name != "" & start_station_name != end_station_name) %>%
  mutate(route_name = ifelse(start_station_name < end_station_name, paste(start_station_name, end_station_name, sep = " - "), paste(end_station_name, start_station_name, sep = " - "))) %>%
  with_groups(c(route_name, month_of_year), mutate, route_count = length(month_of_year)) %>%
  group_by(month_of_year, route_name, member_casual) %>%
  summarize(subgroup_route_count = length(month_of_year), route_count = first(route_count), .groups = "drop") %>%
  group_by(month_of_year) %>% 
  slice_max(na.omit(route_count), n = 10) %>% 
  ungroup()

# create new rows where subgroup_route_count == 0
temp_df <- freq_routes_df %>% filter(subgroup_route_count == route_count)

temp_df$subgroup_route_count <- 0L
temp_df$member_casual <-rep("casual", n = 5)
freq_routes_df <- bind_rows(freq_routes_df, temp_df) %>% arrange(month_of_year, route_name, member_casual)

freq_routes_df
```

Finally, let's create a chart of the top bidirectional routes excluding trips starting and ending at the same station_name for each month of the one year period.

```{r}
month_mapper <- c(paste(month.abb[c(4:12)], 2020), paste(month.abb[c(1:3)], 2021))
names(month_mapper) <- levels(bikeshare_df$month_of_year)

ggplot(freq_routes_df, aes(y = route_name, x = subgroup_route_count, fill = member_casual)) +
  geom_bar(position = "dodge", stat = "identity") + 
  facet_grid(month_of_year ~ ., scales = "free", space = "free", labeller = as_labeller(month_mapper)) +
  xlab("Total Number of Trips (bidirectional)") +
  ylab(" ") +
  guides(fill=guide_legend(title="Rider Type")) + 
  labs(title = "Most Frequent Monthly Bike Routes (Bidirectional)")
```

The most frequent monthly routes are highest in July and August 2020 for casual riders.